<!DOCTYPE html>
<html lang="en">
<head>
    <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
            integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
            crossorigin=""
    />
    <script
            src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
            integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
            crossorigin=""
    ></script>
    <link rel="shortcut icon" href="assets/favicon.png"/>
    <link rel="stylesheet" href="assets/style.css"/>
    <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.2.0/leaflet-omnivore.min.js'></script>
    <script src="https://unpkg.com/leaflet-geosearch@3.1.0/dist/bundle.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-geosearch@3.1.0/dist/geosearch.css"/>
    <script src="plugins/leaflet-bing-layer.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.js"></script>



    <title>Atlas</title>

    <style>
        body {
            padding: 0;
            margin: 0;
        }
        html, body, #map {
            height: 100%;
            width: 100%;
        }
    </style>
</head>

<body>

<div id="map"></div>

<script>
    var categories = {
        "Bridges": "Bridges",
        "Drains": "Drains",
        "Everything_else": "Everything Else",
        "Larger_abandonments": "Larger Abandonments",
        "Mines_and_Tunnels": "Mines and Tunnels",
        "Places_of_interest": "Places of Interest",
        "Possibly_active": "Possibly Active",
        "Small_abandonments": "Small Abandonments"
    }

    var Bingkey = 'Aq-f5tP6X7YRqe-3Kfr3ZXMHY9qVZ6MtrwIn8RlwYFVVhdo20E163gOLTjgNN_kc'

    var colors = {
        "#558B2F": "green",
        "#E65100": "orange",
        "#0288D1": "blue",
        "#673AB7": "purple",
        "#880E4F": "magenta",
        "#A52714": "red",
        "#FFD600": "yellow",
        "#000000": "black"
    }

    var editpointpopup = {"popup": "", "latitude": 0, "longitude": 0};
    var newpointpopup = {"popup": "", "latitude": 0, "longitude": 0};
    var pointProperties = {"name": "", "description": "", "color": "", "type": "", "special": ""}

    // Maps
    var osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 20,
        maxNativeZoom: 19,
        attribution: '<a href="https://octet.llc/atlas/api/login">Login</a>'
    });

    var googleHybrid = L.tileLayer('http://{s}.google.com/vt?lyrs=s,h&x={x}&y={y}&z={z}',{
        maxZoom: 20,
        subdomains:['mt0','mt1','mt2','mt3']
    });

    var openTopo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
        maxzoom: 20,
        maxNativeZoom: 17,
    })

    var bingLabeless = new L.tileLayer.bing(Bingkey, {imagerySet: 'CanvasDark',
        maxZoom: 25,
        maxNativeZoom: 20,
    });

    var VFR = L.tileLayer('https://maps.iflightplanner.com/Maps/Tiles/Sectional/Z{z}/{y}/{x}.png', {
        maxZoom: 20,
        maxNativeZoom: 11,
    });



    // Layers
    var editableLayers = new L.FeatureGroup();

    var railwayMap = L.tileLayer('https://{s}.tiles.openrailwaymap.org/standard/{z}/{x}/{y}.png',{
        maxZoom: 20,
    });

    var lightPollution = L.tileLayer('https://djlorenz.github.io/astronomy/lp2020/overlay/tiles/tile_{z}_{x}_{y}.png', {
        maxZoom: 20,
        maxNativeZoom: 6,
        opacity: 0.5,
    })

    var placesToExplore = L.geoJSON([{}], {
        style: function (feature) {
            return feature.properties && feature.properties.style;
        },

        onEachFeature: onEachFeature,

        pointToLayer: function (feature, latlng) {
            if (feature.properties.special) {
                return L.circleMarker(latlng, {
                    radius: 8,
                    fillColor: feature.properties.color,
                    color: '#fff',
                    weight: 3,
                    opacity: 1,
                    fillOpacity: 0.8
                });
            }
            return L.circleMarker(latlng, {
                radius: 8,
                fillColor: feature.properties.color,
                color: '#000',
                weight: 1,
                opacity: 1,
                fillOpacity: 0.8
            });
        }
    })

    var nikeSites = new L.GeoJSON.AJAX("assets/missilesites/nike/nike.geojson", {
        style: function (feature) {
            return feature.properties && feature.properties.style;
        },

        onEachFeature: missileFeature,

        pointToLayer: function (feature, latlng) {
            return L.circleMarker(latlng, {
                radius: 8,
                fillColor: '#DC5252',
                color: '#FFA6A6',
                weight: 1,
                opacity: 1,
                fillOpacity: 0.8
            });
        }
    })

    var minutemanSites = new L.GeoJSON.AJAX("assets/missilesites/minuteman/minuteman.geojson", {
        style: function (feature) {
            return feature.properties && feature.properties.style;
        },

        onEachFeature: missileFeature,

        pointToLayer: function (feature, latlng) {
            return L.circleMarker(latlng, {
                radius: 8,
                fillColor: '#FFA6A6',
                color: '#DC5252',
                weight: 1,
                opacity: 1,
                fillOpacity: 0.8
            });
        }
    })


    var longLines = new L.GeoJSON.AJAX("assets/long-lines/long-lines.geojson", {
        style: function (feature) {
            return feature.properties && feature.properties.style;
        },

        onEachFeature: longLinesFeature,

        pointToLayer: function (feature, latlng) {
            return L.circleMarker(latlng, {
                radius: 6,
                fillColor: '#1991A4',
                color: '#227784',
                weight: 1,
                opacity: 1,
                fillOpacity: 0.6
            });
        }
    })


    async function initPtE() {
        data = await fetchMapData();
        console.log(data)
        placesToExplore.addData(data.success);
        placesToExplore.redraw();
    }

    initPtE()




    // Map creation
    var map = L.map('map', {
        center: [39.50, -98.35],
        zoom: 5,
        layers: [osm, googleHybrid, placesToExplore, editableLayers]
    });

    var baseLayers = {
        'OpenStreetMap': osm,
        'Google Hybrid': googleHybrid,
        'Bing Labeless': bingLabeless,
        'Open Topo': openTopo,
        'VFR': VFR,
    };

    var overlays = {
        'Places to explore': placesToExplore,
        'OpenRailway Map': railwayMap,
        'Light Pollution': lightPollution,
        'Nike Sites': nikeSites,
        'Minuteman Sites': minutemanSites,
        'Long Lines': longLines,
    };




    // Searchbox
    const provider = new window.GeoSearch.OpenStreetMapProvider();
    const search = new GeoSearch.GeoSearchControl({
        provider: provider,
        style: 'bar',
        updateMap: true,
        autoClose: true,
    }); // Include the search box with usefull params. Autoclose and updateMap in my case. Provider is a compulsory parameter.

    
    // Edit layer
    var DrawnMarker = L.Icon.extend({
        options: {
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            iconUrl: 'assets/drawn-icon.png',
        }
    });

    var drawPluginOptions = {
    position: 'bottomright',
    draw: {
        polyline: {
            shapeOptions: {
                color: '#bada55',
                weight: 10
            }
        },
        polygon: {
            allowIntersection: false, // Restricts shapes to simple polygons
            drawError: {
                color: '#e1e100', // Color the shape will turn when intersects
                message: '<strong>Polygon draw does not allow intersections!<strong> (allowIntersection: false)' // Message that will show when intersect
            },
            shapeOptions: {
                color: '#bada55'
            }
        },
        rectangle: {
            shapeOptions: {
                color: '#bada55'
            }
        },
        circle: {
            shapeOptions: {
                color: '#bada55'
            }
        },
        marker: {
            icon: new DrawnMarker()
        }
    },
    edit: {
        featureGroup: editableLayers
    }
    };




    // Add everything to the map
    var drawControl = new L.Control.Draw(drawPluginOptions);
    map.addControl(drawControl);

    map.on(L.Draw.Event.CREATED, function (e) {
        var layer = e.layer;
            editableLayers.addLayer(layer);
    });



    map.addControl(search);

    var layerControl = L.control.layers(baseLayers, overlays).addTo(map);


    // Popups
    function onEachFeature(feature, layer) {
        var popupContent = "<div id='center'>" + feature.geometry.coordinates[1] + ", " + feature.geometry.coordinates[0] + "<hr><b>" + feature.properties.Name + "</div></b>";

        if (feature.properties.description) {
            popupContent += "<div id='placedescription'>" + feature.properties.description + "</div>";
        }

        popupContent += "<span id='pointtype'><i>type:</i> " + categories[feature.properties.category] + "</span>"

        popupContent += "<button type='button' id='editbutton' class='btn btn-primary edit-marker-button'>Edit</button>"
        //popupContent += "<button type='button' id='editmarkerbutton'>edit</button>"

        layer.on({
            click: function(event) {
                editpointpopup["latitude"] = editpointpopup["popup"] = event.latlng["lat"];
                editpointpopup["longitude"] = editpointpopup["popup"] = event.latlng["lng"];

                pointProperties["lat"] = feature.geometry.coordinates[1];
                pointProperties["lng"] = feature.geometry.coordinates[0];
                pointProperties["name"] = feature.properties.Name;
                pointProperties["description"] = feature.properties.description;
                pointProperties["color"] = feature.properties.color;
                pointProperties["category"] = feature.properties.category;
                pointProperties["special"] = feature.properties.special;
                console.log(pointProperties);


                editpointpopup["popup"] = L.popup()
                    .setLatLng(event.latlng)
                    .setContent(popupContent)
                    .addTo(map)
                    .openOn(map);
            }
        })
    }

    function missileFeature(feature, layer) {
        var popupContent = "<div id='center'>" + feature.geometry.coordinates[1] + ", " + feature.geometry.coordinates[0] + "<hr><b> Missile Site " + feature.properties.name + "</div></b>";

        if (feature.properties.description) {
            popupContent += "<div id='placedescription'>" + feature.properties.description + "</div>";
        }

        layer.on({
            click: function(event) {
                L.popup()
                    .setLatLng(event.latlng)
                    .setContent(popupContent)
                    .addTo(map)
                    .openOn(map);
            }
        })
    }

    function longLinesFeature(feature, layer) {
        var popupContent = "<div id='center'>" + feature.geometry.coordinates[1] + ", " + feature.geometry.coordinates[0] + "<hr><b> Long Lines Site: " + feature.properties.name + "</div></b>";

        if (feature.properties.description) {
            popupContent += "<div id='placedescription'>" + feature.properties.description + "</div>";
        }

        layer.on({
            click: function(event) {
                L.popup()
                    .setLatLng(event.latlng)
                    .setContent(popupContent)
                    .addTo(map)
                    .openOn(map);
            }
        })
    }

    map.on('contextmenu',(e) => {
        newpointpopup["latitude"] = e.latlng.lat;
        newpointpopup["longitude"] = e.latlng.lng;

        const gHref = `https://maps.google.com/?q=${e.latlng.lat},${e.latlng.lng}&t=h`
        const gMaps = `<a href="${gHref}" target="_blank">Google Maps</a>`

        const bHref = `https://maps.bing.com/?q=${e.latlng.lat},${e.latlng.lng}&style=h`
        const bMaps = `<a href="${bHref}" target="_blank">Bing Maps</a>`

        const sHref = `https://apps.sentinel-hub.com/sentinel-playground/?source=S2L2A&lat=${e.latlng.lat}&lng=${e.latlng.lng}&zoom=16&preset=1_TRUE_COLOR&layers=B01,B02,B03`
        const sentinel = `<a href="${sHref}" target="_blank">Sentinel Playground</a>`

        const aHref = `https://www.antennasearch.com/HTML/search/search.php?address=${e.latlng.lat}%2C+${e.latlng.lng}`
        const antennaFinder = `<a href="${aHref}" target="_blank">Run antenna finder</a>`

        const wHref = `https://darksky.net/forecast/${e.latlng.lat},${e.latlng.lng}/us12/en`
        const weather = `<a href="${wHref}" target="_blank">Run Darksky forecast</a>`

        newpointpopup["popup"] = L.popup()
            newpointpopup["popup"].setLatLng(e.latlng)
            newpointpopup["popup"].setContent(e.latlng.lat + ", " + e.latlng.lng +
                "<hr>Maps:<br><div id='indented'>- " + gMaps + "<br>- " + bMaps +"<br>- " + sentinel + "<br> </div>" +
                "<br>Services:<br> <div id='indented'> - " + antennaFinder + "<br>- " + weather +
                '<button type="button" id="createmarkerbutton" class="btn btn-primary create-marker-button">+</button></div>')
            newpointpopup["popup"].addTo(map)
            newpointpopup["popup"].openOn(map);
    });

    $(document).on("click", ".create-marker-button", function () {
        newpointform = "<textarea id='pointname' placeholder='name' rows='1' cols='31'></textarea><br>" +
            "<textarea id='description' placeholder='description' rows='5' cols='31'></textarea><br>" +
            "<select id='color'>" +
            "<option value='#558B2F'>Green</option>" +
            "<option value='#E65100'>Orange</option>" +
            "<option value='#0288D1'>Blue</option>" +
            "<option value='#673AB7'>Purple</option>" +
            "<option value='#880E4F'>Magenta</option>" +
            "<option value='#A52714'>Red</option>" +
            "<option value='#FFD600'>Yellow</option>" +
            "<option value='#000000'>Black</option>" +
            "</select>" +
            "<select id='category'>" +
            "<option value='Small_abandonments'>Small Abandonments</option>" +
            "<option value='Larger_abandonments'>Larger Abandonments</option>" +
            "<option value='Possibly_active'>Possibly Active</option>" +
            "<option value='Bridges'>Bridges</option>" +
            "<option value='Mines_and_Tunnels'>Mines and Tunnels</option>" +
            "<option value='Drains'>Drains</option>" +
            "<option value='Places_of_interest'>Places of Interest</option>" +
            "<option value='Everything_else'>Everything Else</option>" +
            "</select><br><br>" +
            "<input type='checkbox' id='special'><label>Special</label>" +
            "<button id='submitpoint' class='btn btn-primary submit-point'>Submit</button>"
        newpointpopup["popup"].setContent(newpointform)
    });

    $(document).on("click", ".submit-point", function (event) {
        event.preventDefault();

        var pointname = $('#pointname').val();
        var description = $('#description').val();
        var color = $('#color').val();
        var category = $('#category').val();
        var special = $('#special').prop('checked');

        console.log(pointname, description, color, category, special)
        $(".leaflet-popup-close-button")[0].click();

        postNewPoint({"lat": newpointpopup["latitude"], "lng": newpointpopup["longitude"], "name": pointname, "description": description, "color": color, "category": category, "special": special})
    });

    $(document).on("click", ".edit-marker-button", function () {
        editpointform = "<textarea id='latitude' placeholder=" + editpointpopup["latitude"] + " rows='1'></textarea><textarea id='longitude' placeholder=" + editpointpopup["longitude"] + " rows='1'></textarea><br>" +
            "<textarea id='pointname' placeholder='name' rows='1' cols='31'>" + pointProperties["name"] + "</textarea><br>" +
            "<textarea id='description' placeholder='description' rows='5' cols='31'>" + pointProperties["description"] + "</textarea><br>" +
            "<select id='editColor'>" +
            "<option value='#558B2F'>Green</option>" +
            "<option value='#E65100'>Orange</option>" +
            "<option value='#0288D1'>Blue</option>" +
            "<option value='#673AB7'>Purple</option>" +
            "<option value='#880E4F'>Magenta</option>" +
            "<option value='#A52714'>Red</option>" +
            "<option value='#FFD600'>Yellow</option>" +
            "<option value='#000000'>Black</option>" +
            "</select>" +
            "<select id='editCategory'>" +
            "<option value='Small_abandonments'>Small Abandonments</option>" +
            "<option value='Larger_abandonments'>Larger Abandonments</option>" +
            "<option value='Possibly_active'>Possibly Active</option>" +
            "<option value='Bridges'>Bridges</option>" +
            "<option value='Mines_and_Tunnels'>Mines and Tunnels</option>" +
            "<option value='Drains'>Drains</option>" +
            "<option value='Places_of_interest'>Places of Interest</option>" +
            "<option value='Everything_else'>Everything Else</option>" +
            "</select><br>" +
            "<textarea id='delete' placeholder='type &apos;delete&apos; to delete' rows='1' cols='31'></textarea><br>" +
            "<input type='checkbox' id='editSpecial'><label>Special</label>" +
            "<button id='editpoint' class='btn btn-primary edit-point'>Submit</button>"

        editpointpopup["popup"].setContent(editpointform);

        console.log(pointProperties["special"]);

        $("#editCategory").val(pointProperties["category"]);
        $("#editColor").val([pointProperties["color"]]);
        $("#editSpecial").prop("checked", pointProperties["special"]);

    });


    $(document).on("click", ".edit-point", function (event) {
        event.preventDefault();
        var latitude = parseFloat($('#latitude').val());
        var longitude = parseFloat($('#longitude').val());
        var pointname = $('#pointname').val();
        var description = $('#description').val();
        var todelete = $('#delete').val();
        var color = $('#editColor').val();
        var category = $('#editCategory').val();
        var special = $('#editSpecial').prop('checked');

        console.log(category, color, special);

        $(".leaflet-popup-close-button")[0].click();

        PutPoint({"lat": editpointpopup["latitude"], "lng": editpointpopup["longitude"], "newlat": latitude, "newlng": longitude, "name": pointname, "description": description, "color": color, "category": category, "special": special, "delete": todelete})
    });

    $(document).on("click", ".delete-marker-button", function (event) {
        event.preventDefault();

        deletePoint({"lat": editpointpopup["latitude"], "lng": editpointpopup["longitude"]})
    });


    async function fetchMapData() {
        let obj;
        const res = await fetch("https://octet.llc/atlas/api/map/")
        obj = await res.json();
        return obj;
    }

    function postNewPoint(pointdata) {
        fetch("https://octet.llc/atlas/api/add/", {
            method: "POST",
            headers: {
                'accept': 'application/json',
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(pointdata),
        })
        // Update local data
        console.log(pointdata)
        placesToExplore.addData(pointdata)
    }

    function deletePoint(pointdata) {
        fetch("https://octet.llc/atlas/api/del/", {
            method: "DELETE",
            headers: {
                'accept': 'application/json',
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(pointdata)
        })
    }

    function PutPoint(pointdata) {
        fetch("https://octet.llc/atlas/api/put/", {
            method: "PUT",
            headers: {
                'accept': 'application/json',
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(pointdata),
        })
    }

</script>


</body>

</html>