<!DOCTYPE html>
<html lang="en">
<head>
    <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
            integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
            crossorigin=""
    />
    <script
            src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
            integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
            crossorigin=""
    ></script>
    <link rel="stylesheet" href="assets/style.css"/>
    <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.2.0/leaflet-omnivore.min.js'></script>
    <script src="https://unpkg.com/leaflet-geosearch@3.1.0/dist/bundle.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-geosearch@3.1.0/dist/geosearch.css"/>
    <script src="plugins/leaflet-bing-layer.js"></script>


    <title>Atlas</title>

    <style>
        body {
            padding: 0;
            margin: 0;
        }
        html, body, #map {
            height: 100%;
            width: 100%;
        }
    </style>
</head>

<body>

<div id="map"></div>

<script>
    var categories = {
        "Bridges": "Bridges",
        "Drains": "Drains",
        "Everything_else": "Everything Else",
        "Larger_abandonments": "Larger Abandonments",
        "Mines_and_Tunnels": "Mines and Tunnels",
        "Places_of_interest": "Places of Interest",
        "Possibly_active": "Possibly Active",
        "Small_abandonments": "Small Abandonments"
    }

    var Bingkey = 'Aq-f5tP6X7YRqe-3Kfr3ZXMHY9qVZ6MtrwIn8RlwYFVVhdo20E163gOLTjgNN_kc'




    // Maps
    var osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 20,
        maxNativeZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    });

    var googleHybrid = L.tileLayer('http://{s}.google.com/vt?lyrs=s,h&x={x}&y={y}&z={z}',{
        maxZoom: 20,
        subdomains:['mt0','mt1','mt2','mt3']
    });

    var openTopo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
        maxzoom: 20,
        maxNativeZoom: 17,
    })

    var bingLabeless = new L.tileLayer.bing(Bingkey, {imagerySet: 'CanvasDark',
        maxZoom: 25,
        maxNativeZoom: 20,
    });




    // Layers
    var railwayMap = L.tileLayer('https://{s}.tiles.openrailwaymap.org/standard/{z}/{x}/{y}.png',{
        maxZoom: 20,
    });

    var lightPollution = L.tileLayer('https://djlorenz.github.io/astronomy/lp2020/overlay/tiles/tile_{z}_{x}_{y}.png', {
        maxZoom: 20,
        maxNativeZoom: 6,
        opacity: 0.5,
    })

    var placesToExplore = L.geoJSON([{}], {
        style: function (feature) {
            return feature.properties && feature.properties.style;
        },

        onEachFeature: onEachFeature,

        pointToLayer: function (feature, latlng) {
            if (feature.properties.special) {
                return L.circleMarker(latlng, {
                    radius: 8,
                    fillColor: feature.properties.color,
                    color: '#fff',
                    weight: 3,
                    opacity: 1,
                    fillOpacity: 0.8
                });
            }
            return L.circleMarker(latlng, {
                radius: 8,
                fillColor: feature.properties.color,
                color: '#000',
                weight: 1,
                opacity: 1,
                fillOpacity: 0.8
            });
        }
    })

    async function initPtE() {
        data = await fetchMapData();
        console.log(data)
        placesToExplore.addData(data.success);
    }

    initPtE()




    // Map creation
    var map = L.map('map', {
        center: [39.50, -98.35],
        zoom: 5,
        layers: [osm, googleHybrid, placesToExplore]
    });

    var baseLayers = {
        'OpenStreetMap': osm,
        'Google Hybrid': googleHybrid,
        'Bing Labeless': bingLabeless,
        'Open Topo': openTopo,
    };

    var overlays = {
        'Places to explore': placesToExplore,
        'OpenRailway Map': railwayMap,
        'Light Pollution': lightPollution,

    };




    // Searchbox
    const provider = new window.GeoSearch.OpenStreetMapProvider();
    const search = new GeoSearch.GeoSearchControl({
        provider: provider,
        style: 'bar',
        updateMap: true,
        autoClose: true,
    }); // Include the search box with usefull params. Autoclose and updateMap in my case. Provider is a compulsory parameter.

    map.addControl(search);

    var layerControl = L.control.layers(baseLayers, overlays).addTo(map);




    // Popups
    function onEachFeature(feature, layer) {
        var popupContent = "<div id='center'>" + feature.geometry.coordinates[0] + ", " + feature.geometry.coordinates[1] + "<hr><b>" + feature.properties.Name + "</div></b>";

        if (feature.properties.description) {
            popupContent += "<div id='placedescription'>" + feature.properties.description + "</div>";
        }

        popupContent += "<span id='pointtype'><i>type:</i> " + categories[feature.properties.category] + "</span>"
        layer.bindPopup(popupContent);
    }

    map.on('contextmenu',(e) => {
        const gHref = `https://maps.google.com/?q=${e.latlng.lat},${e.latlng.lng}&t=h`
        const gMaps = `<a href="${gHref}" target="_blank">Google Maps</a>`

        const bHref = `https://maps.bing.com/?q=${e.latlng.lat},${e.latlng.lng}&style=h`
        const bMaps = `<a href="${bHref}" target="_blank">Bing Maps</a>`

        const sHref = `https://apps.sentinel-hub.com/sentinel-playground/?source=S2L2A&lat=${e.latlng.lat}&lng=${e.latlng.lng}&zoom=16&preset=1_TRUE_COLOR&layers=B01,B02,B03`
        const sentinel = `<a href="${sHref}" target="_blank">Sentinel Playground</a>`

        const aHref = `https://www.antennasearch.com/HTML/search/search.php?address=${e.latlng.lat}%2C+${e.latlng.lng}`
        const antennaFinder = `<a href="${aHref}" target="_blank">Run antenna finder</a>`

        const wHref = `https://darksky.net/forecast/${e.latlng.lat},${e.latlng.lng}/us12/en`
        const weather = `<a href="${wHref}" target="_blank">Run Darksky forecast</a>`

        L.popup()
            .setLatLng(e.latlng)
            .setContent(e.latlng.lat + ", " + e.latlng.lng +
                "<hr>Maps:<br><div id='indented'>- " + gMaps + "<br>- " + bMaps +"<br>- " + sentinel + "<br> </div>" +
                "<br>Services:<br> <div id='indented'> - " + antennaFinder + "<br>- " + weather +
                '<button type="button" id="createmarkerbutton" class="btn btn-primary create-marker-button" data = "' + [e.latlng.lat, e.latlng.lng] + '" ' + '>+</button></div>')
            .addTo(map)
            .openOn(map);
    });

    $("div").on("click", '.create-marker-button', function () {
        var data = $(this).attr("data").split(",");
        addMarker(parseFloat(data[0]), parseFloat(data[1]));
    });

    function addMarker(lat, lng) {
        placesToExplore.addData({ "type": "Feature", "properties": { "Name": "Casa Grande Domes", "description": null, "gx_media_links": null }, "geometry": { "type": "Point", "coordinates": [ lat, lng ] } })
        map.invalidateSize()
        console.log("Reloaded")
        var newMarker = new L.marker([lat, lng]).addTo(map);
    }

    async function fetchMapData() {
        let obj;
        const res = await fetch("http://localhost:5001/map/")
        obj = await res.json();
        return obj;
    }


</script>


</body>

</html>